

#### 2. 各個系統的權衡策略

##### a. PostgreSQL：正確性優先

- **機制**：PostgreSQL 透過強大的事務（BEGIN; ... COMMIT;）和行級鎖定（SELECT FOR UPDATE）來確保資料的正確性和一致性。
- **問題點**：
- **競爭條件**：在沒有 FOR UPDATE 的情況下，多個事務可以同時讀取相同的庫存數量，導致超賣。
- **鎖定解決方案的效能衝擊**：SELECT FOR UPDATE 確實解決了競爭條件，但會導致其他事務「必須等待」。這創建了一個佇列，在高流量下，「你可能會每秒處理 50 個訂單而不是 1,000 個。」任何熱門產品都會成為整個系統的序列化點。
- **序號問題**：即使是 PostgreSQL 的序號（用於生成 ID）也可能存在間隙，因為它們在事務提交前就已分配。這可能導致「你的記錄相對於它們的 ID 呈現‘無序’」，這對依賴 ID 排序的模式（如 Outbox 模式）至關重要。
- **多版本並行控制（MVCC）**：PostgreSQL 使用事務 ID（XIDs）和 MVCC 來決定可見性，導致不同的並行事務看到不同的資料「快照」。
- **複製延遲**：主資料庫的寫入是立即的，但副本的變更應用是異步的。客戶可能會「下訂單（寫入主實例），然後檢查他們的訂單歷史（從副本讀取）」，卻「什麼也看不到 —— 副本還沒跟上」。

##### b. MongoDB：速度優先（但有陷阱）

- **預設行為**：MongoDB 預設傾向於速度和最終一致性。原始的庫存檢查程式碼與 PostgreSQL 一樣存在競爭條件。
- **複製工作原理**：MongoDB 使用副本集，主節點接受寫入，次節點從操作日誌（oplog）異步複製。這意味著「主節點的數量可能是 5，而次節點仍然顯示 10。」
- **原子操作**：findOneAndUpdate 確保了單一文件更新的原子性，但如果後續的操作（如訂單插入）失敗，則可能出現庫存已減少但無訂單記錄的狀態。
- **多文件事務**：MongoDB 4.0 引入了多文件事務，使其「行為像 PostgreSQL」，但也繼承了其效能特性。「效能測試中，啟用事務後吞吐量下降了 50-60%。」這是因為 MongoDB 現在必須協調鎖定、確保一致的快照、維護回滾日誌並阻塞並發操作。
- **修訂模式**：在最終一致性儲存中處理投影時，讀取可能遇到過時或空資料。解決方案是「追蹤修訂並重試直到看到預期狀態」，但這「增加了複雜性並可能增加延遲」。

##### c. Kafka：為分散式設計（透過分區）

- **設計理念**：Kafka 透過分區來擁抱分散式特性，每個分區保證了內部排序，但「沒有跨分區排序」。
- **分區鍵**：透過使用產品 ID 作為分區鍵，Kafka 保證了「所有產品的事件都按順序處理」，但這僅限於單一分區內。
- **分散式事務問題**：當訂單涉及不同產品（位於不同分區）時，事件可能以任何順序處理。「你的支付可能在庫存甚至還沒被檢查之前就已處理。」這是因為每個消費者組實例獨立處理其分區。
- **ISR 機制**：Kafka 的 ISR（In-Sync Replica）機制確保了同一分區內所有同步副本具有相同順序的訊息，但「這是每個分區 —— 分區之間沒有協調」。
- **Saga 模式**：當遇到排序限制時，開發人員常轉向 Saga 模式。Saga 模式不解決分散式事務問題，而是接受其存在，並「圍繞此事實建立補償機制」。這涉及管理跨多個服務的分散式狀態機，導致「服務之間狀態可能變得不一致」和「增加了延遲」。
- **Kafka 的效能權衡**：
- **冪等性**：啟用冪等性（enable.idempotence: true）可防止重複，但會導致「20% 的效能損失」。
- **Kafka「事務」**：雖然存在，但會帶來「效能懲罰」，因為它們需要與事務協調器協調、寫入標記、確保原子提交和維護事務狀態。最終，為了實現全域排序，你可能需要單一分區，這將使你的分散式系統變成「一個非常昂貴的單線程應用程式」。

#### 3. 兩階段提交 (2PC) 的陷阱

- **目的**：2PC 旨在保證跨系統的一致性。
- **工作原理**：分為「階段 1 - 投票」和「階段 2 - 完成」。
- 兩階段提交（2PC）協議在跨資料中心時，因為網路延遲，鎖會被持有很久（可能數百毫秒）。
- 更嚴重的是，如果協調者在第一階段後崩潰，參與者必須一直保持鎖定，直到協調者恢復，這可能導致「永遠」無法釋放鎖。
- 因此，現代系統通常避免使用2PC，以免造成長時間甚至永久的阻塞問題。
- **行業巨頭的啟示**：即使像 Google Spanner（使用原子鐘和 GPS 同步）和 Amazon DynamoDB（使用向量時鐘）這樣資源無限的公司，也無法消除這些權衡，這證明了這些權衡是分散式系統的「根本」。

#### 4. 與物理定律共存的解決方案

- **模式 1：縮小協調範圍**：識別並僅協調「關鍵業務檢查」所需的操作，而不是協調所有操作。例如，只原子地減少庫存，而不是驗證地址、計算稅費等。
- **模式 2：業務層級解決方案**：
- 調整客戶期望：「僅剩 3 件庫存！」
- 時間限制的保留：「商品保留 10 分鐘」
- 庫存緩衝：保留少量隱藏庫存。
- 優雅降級：「需求量大！訂單待庫存檢查後確認。」
- 如果庫存為零，自動訂購商品，並詢問用戶是否願意等待或退款。
- **模式 3：選擇你的保證**：根據操作的性質選擇不同的保證等級：
- **金融交易**：優先考慮正確性（例如 PostgreSQL）。
- **產品瀏覽**：優先考慮速度和功能（例如 MongoDB、ElasticSearch），可接受最終一致性。
- **分析事件**：優先考慮至少一次交付和使用者會話內的排序（例如 Kafka）。
- **模式 4：冪等性**：使操作可以安全地重試，即使多次應用也能產生相同的結果。這有助於應對重新排序和部分故障。